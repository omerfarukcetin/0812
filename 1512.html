<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minik Kodlamacƒ±lar - Tema D√ºnyasƒ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            transition: background 0.5s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        /* Animations */
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .robot-move { 
            transition: top 0.5s ease-in-out, left 0.5s ease-in-out, transform 0.3s ease; 
        }

        /* Hint Hand Animation */
        .hint-hand {
            position: absolute;
            z-index: 50;
            font-size: 2.5rem;
            pointer-events: none;
            animation: pointHint 1s infinite alternate;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
        }

        @keyframes pointHint {
            from { transform: translateY(0) scale(1); }
            to { transform: translateY(10px) scale(1.1); }
        }

        /* Speech Bubble */
        .speech-bubble {
            position: absolute;
            background: white;
            border-radius: 16px;
            padding: 8px 12px;
            text-align: center;
            font-weight: bold;
            font-size: 0.85rem;
            line-height: 1.2;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 40;
            min-width: 100px;
            max-width: 180px;
            animation: bubblePop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #3b82f6;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: #3b82f6 transparent transparent transparent;
        }
        
        @keyframes bubblePop {
            from { transform: scale(0) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* Preview Path Dot */
        .preview-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: absolute;
            z-index: 5;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(255,255,255,0.8);
            animation: pulseDot 1.5s infinite;
        }

        .preview-target {
            width: 24px;
            height: 24px;
            border: 3px solid #fff;
            border-radius: 50%;
            position: absolute;
            z-index: 6;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.8);
            animation: pulseTarget 1.2s infinite;
            background-color: #22c55e;
        }

        @keyframes pulseDot {
            0% { transform: scale(0.8); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.6; }
        }

        @keyframes pulseTarget {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1.15); box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* Dragging Styles */
        .dragging {
            opacity: 0.5;
            transform: scale(0.9);
            border: 2px dashed #666;
        }
        .drag-over {
            border-left: 4px solid #3b82f6;
            padding-left: 10px;
        }

        /* Confetti Particle */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
            animation: explode 0.8s forwards ease-out;
        }

        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* Star Animation */
        .star-pop { animation: starPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0); }
        .star-pop.delay-1 { animation-delay: 0.2s; }
        .star-pop.delay-2 { animation-delay: 0.4s; }
        .star-pop.delay-3 { animation-delay: 0.6s; }

        @keyframes starPop {
            to { opacity: 1; transform: scale(1); }
        }

        .theme-transition { transition: all 0.5s ease; }

        .btn-press:active {
            transform: translateY(4px);
            box-shadow: none !important;
        }
        
        #code-area::-webkit-scrollbar { width: 8px; }
        #code-area::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        #code-area::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }
    </style>
</head>
<body id="main-body" class="h-screen flex flex-col overflow-hidden bg-cyan-100 text-slate-800 select-none">

    <!-- Navbar & Theme Selector -->
    <header class="w-full glass z-20 px-4 md:px-6 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4">
            <!-- Big Level Menu Button -->
            <button onclick="toggleLevelMenu()" class="bg-yellow-400 hover:bg-yellow-300 text-slate-800 px-4 py-2 rounded-2xl shadow-[0_4px_0_#d97706] active:shadow-none active:translate-y-1 transition-all flex items-center gap-2 border-2 border-yellow-500">
                <span class="text-2xl">üìÇ</span>
                <span class="font-black text-sm md:text-base uppercase tracking-wider">B√ñL√úMLER</span>
            </button>

            <div class="hidden md:block w-[1px] h-10 bg-slate-300"></div>
            
            <div class="flex items-center gap-2">
                <div id="header-icon" class="text-4xl filter drop-shadow-md hidden sm:block">üêøÔ∏è</div>
                <h1 class="hidden md:block text-xl font-black text-slate-700 tracking-tight leading-none">Mƒ∞Nƒ∞K<br><span class="text-blue-500" id="brand-color">KODLAMACILAR</span></h1>
            </div>
        </div>

        <!-- Theme Selector -->
        <div class="hidden lg:flex gap-2 bg-slate-100/50 p-1.5 rounded-2xl">
            <button onclick="setTheme('ice')" class="text-2xl p-2 hover:bg-white rounded-xl transition hover:scale-110" title="Buz Devri">üêøÔ∏è</button>
            <button onclick="setTheme('dino')" class="text-2xl p-2 hover:bg-white rounded-xl transition hover:scale-110" title="Dinozor">ü¶ñ</button>
            <button onclick="setTheme('car')" class="text-2xl p-2 hover:bg-white rounded-xl transition hover:scale-110" title="Yarƒ±≈ü">üèéÔ∏è</button>
            <button onclick="setTheme('lion')" class="text-2xl p-2 hover:bg-white rounded-xl transition hover:scale-110" title="Safari">ü¶Å</button>
            <button onclick="setTheme('rabbit')" class="text-2xl p-2 hover:bg-white rounded-xl transition hover:scale-110" title="Orman">üê∞</button>
        </div>

        <div class="glass px-4 py-2 rounded-xl text-center min-w-[140px]">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Hedef</div>
            <div id="instruction-text" class="font-bold text-slate-700 text-sm md:text-base">Me≈üe Palamuduna Git</div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row gap-4 md:gap-6 p-4 md:p-8 max-w-[1600px] mx-auto w-full h-full relative">
        
        <!-- Left: Game Board -->
        <div class="flex-1 flex flex-col justify-center items-center relative">
            
            <!-- Level Indicator & Direct Navigation -->
            <div class="absolute top-0 left-0 glass px-2 py-2 rounded-full text-slate-600 mb-4 flex items-center shadow-sm gap-2">
                <button onclick="prevLevel()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center hover:bg-slate-100 shadow text-slate-500 font-bold transition">‚ùÆ</button>
                <div class="flex flex-col items-center px-2 min-w-[100px]">
                    <span class="text-[10px] font-bold uppercase text-slate-400 leading-none" id="chapter-title">B√ñL√úM 1</span>
                    <span class="text-lg font-black leading-tight" id="level-indicator">Seviye 1</span>
                </div>
                <button onclick="nextLevel()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center hover:bg-slate-100 shadow text-slate-500 font-bold transition">‚ùØ</button>
            </div>

            <!-- The Grid -->
            <div class="bg-white/40 p-3 rounded-[2rem] shadow-2xl backdrop-blur-sm border-4 border-white/60 relative z-10">
                <div id="game-board" class="grid grid-cols-5 gap-2 md:gap-3 w-[320px] h-[320px] md:w-[450px] md:h-[450px] relative">
                    <!-- Cells generated via JS -->
                </div>
            </div>

            <!-- Victory Modal with Stars -->
            <div id="result-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm rounded-3xl">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-2xl text-center transform scale-110 max-w-sm mx-4 w-full border-4 border-green-100">
                    <div class="text-5xl mb-2 animate-bounce">üéâ</div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2">Ba≈üardƒ±n!</h2>
                    
                    <div class="flex justify-center gap-2 mb-4 h-16 items-center" id="star-container"></div>

                    <p id="modal-msg" class="text-slate-500 mb-6 font-medium text-sm">Harika bir i≈ü √ßƒ±kardƒ±n.</p>
                    <button onclick="nextLevel()" class="w-full bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 md:py-4 rounded-2xl shadow-[0_6px_0_#15803d] btn-press transition-all">
                        Sonraki Seviye ‚û°Ô∏è
                    </button>
                    <button onclick="retryLevel()" class="mt-3 w-full text-slate-400 font-bold hover:text-slate-600">
                        Tekrar Oyna üîÑ
                    </button>
                </div>
            </div>

             <!-- Fail Modal -->
             <div id="fail-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm rounded-3xl">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-2xl text-center transform scale-110 max-w-sm mx-4 w-full border-4 border-orange-100">
                    <div class="text-5xl mb-4 animate-pulse">ü§î</div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2">Eyvah!</h2>
                    <p class="text-slate-500 mb-6 font-medium">Bir ≈üeyler ters gitti.</p>
                    <button onclick="retryLevel()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-bold py-4 rounded-2xl shadow-[0_6px_0_#a16207] btn-press transition-all">
                        Tekrar Dene üîÑ
                    </button>
                </div>
            </div>

            <!-- Level Selection Modal (Map) -->
            <div id="level-menu" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-slate-900/80 backdrop-blur-md rounded-3xl p-4">
                <div class="bg-white p-6 rounded-[2rem] shadow-2xl max-w-3xl w-full h-[85%] flex flex-col border-4 border-yellow-400">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-4xl">üó∫Ô∏è</span>
                            <div>
                                <h2 class="text-3xl font-black text-slate-800">Seviye Haritasƒ±</h2>
                                <p class="text-slate-500 font-bold text-sm">ƒ∞stediƒüin b√∂l√ºm√º se√ß ve oyna!</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="resetProgress()" class="text-sm text-red-400 hover:text-red-600 font-bold px-3 py-2 bg-red-50 rounded-lg">Sƒ±fƒ±rla</button>
                            <button onclick="toggleLevelMenu()" class="bg-slate-100 hover:bg-slate-200 w-10 h-10 rounded-full font-bold text-slate-600 text-xl">‚úï</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 p-2 content-start" id="level-grid">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Coding Interface -->
        <div class="w-full md:w-[420px] lg:w-[480px] flex flex-col gap-4 h-full max-h-[calc(100vh-140px)]">
            
            <!-- Toolbox -->
            <div class="glass p-4 rounded-3xl shrink-0 relative flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase">Bloklar</span>
                    <span id="loop-indicator" class="hidden text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded">D√∂ng√º Modu</span>
                </div>

                <!-- Loop Multipliers (Hidden by default) -->
                <div id="loop-controls" class="hidden grid grid-cols-4 gap-2 mb-1">
                    <button onclick="setLoop(2)" class="loop-btn bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-1 rounded-lg border border-purple-300 transition-colors">2x</button>
                    <button onclick="setLoop(3)" class="loop-btn bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-1 rounded-lg border border-purple-300 transition-colors">3x</button>
                    <button onclick="setLoop(4)" class="loop-btn bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-1 rounded-lg border border-purple-300 transition-colors">4x</button>
                    <button onclick="setLoop(5)" class="loop-btn bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-1 rounded-lg border border-purple-300 transition-colors">5x</button>
                </div>

                <!-- Buttons Container -->
                <div class="grid grid-cols-4 gap-2 md:gap-3" id="toolbox-buttons">
                    <button onclick="addCommand('up')" id="btn-up" class="btn-press bg-blue-500 hover:bg-blue-400 text-white aspect-square rounded-2xl shadow-[0_4px_0_#1e40af] md:shadow-[0_6px_0_#1e40af] flex items-center justify-center text-4xl transition-colors">‚¨ÜÔ∏è</button>
                    <button onclick="addCommand('down')" id="btn-down" class="btn-press bg-violet-500 hover:bg-violet-400 text-white aspect-square rounded-2xl shadow-[0_4px_0_#5b21b6] md:shadow-[0_6px_0_#5b21b6] flex items-center justify-center text-4xl transition-colors">‚¨áÔ∏è</button>
                    <button onclick="addCommand('left')" id="btn-left" class="btn-press bg-amber-500 hover:bg-amber-400 text-white aspect-square rounded-2xl shadow-[0_4px_0_#92400e] md:shadow-[0_6px_0_#92400e] flex items-center justify-center text-4xl transition-colors">‚¨ÖÔ∏è</button>
                    <button onclick="addCommand('right')" id="btn-right" class="btn-press bg-rose-500 hover:bg-rose-400 text-white aspect-square rounded-2xl shadow-[0_4px_0_#9f1239] md:shadow-[0_6px_0_#9f1239] flex items-center justify-center text-4xl transition-colors">‚û°Ô∏è</button>
                </div>
                <!-- Hint Hand Container -->
                <div id="hint-container" class="absolute inset-0 pointer-events-none z-50 hidden"></div>
            </div>

            <!-- Workspace -->
            <div class="flex-1 glass flex flex-col rounded-3xl overflow-hidden border-4 border-slate-200/50">
                <div class="bg-slate-100/80 px-4 py-2 border-b border-slate-200 flex justify-between items-center shrink-0">
                    <span class="font-bold text-slate-600 text-sm md:text-base">Kod Alanƒ±</span>
                    <button onclick="clearWorkspace()" class="text-slate-400 hover:text-red-500 transition-colors bg-white px-2 py-1 rounded-lg border border-slate-200 shadow-sm text-xs font-bold uppercase" title="Hepsini Sil">
                        Temizle
                    </button>
                </div>

                <!-- Code Grid Area -->
                <div id="code-area" class="flex-1 overflow-y-auto p-4 bg-slate-50/50 scroll-smooth">
                    <div id="code-grid" class="grid grid-cols-4 gap-2 content-start">
                        <div class="col-span-full text-center mt-10 opacity-30 select-none">
                            <div class="text-5xl md:text-6xl mb-2">üß©</div>
                            <div class="font-bold text-slate-800 text-sm md:text-base">Bloklarƒ± buraya diz</div>
                        </div>
                    </div>
                </div>

                <!-- Run Button Area -->
                <div class="p-3 md:p-4 bg-white/60 backdrop-blur-md border-t border-slate-200 shrink-0 flex gap-2">
                    
                    <!-- Speed Toggle -->
                    <button onclick="toggleSpeed()" id="speed-btn" class="bg-indigo-100 hover:bg-indigo-200 text-2xl w-16 rounded-2xl border-2 border-indigo-200 shadow-sm flex items-center justify-center transition-colors">
                        üê¢
                    </button>

                    <button onclick="runCode()" id="run-btn" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white text-xl md:text-2xl font-black py-3 md:py-4 rounded-2xl shadow-[0_6px_0_#0f172a] btn-press flex items-center justify-center gap-3 transition-all">
                        <span class="text-2xl md:text-3xl">‚ñ∂Ô∏è</span> BA≈ûLAT
                    </button>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SAVE_KEY = 'minik_kodlamacilar_save_v3'; // Incremented key for new structure
        let gameSpeed = 600;
        let isFastMode = false;
        let hintTimer = null;
        let hintDelay = 15000;
        
        let activeLoopCount = 1; // Current loop multiplier

        const themes = {
            ice: { name: 'Buz Devri', bgClass: 'bg-cyan-100', cellClass: 'bg-cyan-50 border-cyan-100', obstacleIcon: 'üßä', playerIcon: 'üêøÔ∏è', defaultFacing: 'left', targetPrimary: 'üå∞', targetSecondary: 'ü••', dotColor: '#ef4444', accentText: 'text-cyan-600' },
            dino: { name: 'Dinozor', bgClass: 'bg-stone-200', cellClass: 'bg-stone-50 border-stone-200', obstacleIcon: 'üåã', playerIcon: 'ü¶ñ', defaultFacing: 'left', targetPrimary: 'üçñ', targetSecondary: 'ü•ö', dotColor: '#3b82f6', accentText: 'text-stone-600' },
            car: { name: 'Yarƒ±≈ü', bgClass: 'bg-slate-200', cellClass: 'bg-slate-50 border-slate-300', obstacleIcon: 'üöß', playerIcon: 'üèéÔ∏è', defaultFacing: 'right', targetPrimary: 'üèÅ', targetSecondary: '‚õΩ', dotColor: '#ef4444', accentText: 'text-slate-600' },
            lion: { name: 'Safari', bgClass: 'bg-amber-100', cellClass: 'bg-orange-50 border-orange-200', obstacleIcon: 'üåµ', playerIcon: 'ü¶Å', defaultFacing: 'left', targetPrimary: 'ü•©', targetSecondary: 'üíß', dotColor: '#3b82f6', accentText: 'text-orange-600' },
            rabbit: { name: 'Orman', bgClass: 'bg-green-100', cellClass: 'bg-green-50 border-green-200', obstacleIcon: 'ü™µ', playerIcon: 'üê∞', defaultFacing: 'left', targetPrimary: 'ü•ï', targetSecondary: 'ü•¶', dotColor: '#ef4444', accentText: 'text-green-600' }
        };

        let currentTheme = themes.ice;
        let currentLevelIndex = 0;
        let workspace = [];
        let isRunning = false;
        let playerPos = { x: 0, y: 0 };
        let playerFacing = 'right'; 
        let collectedItems = 0;
        let maxUnlockedLevel = 0;
        let levelStars = {};

        // --- NEW LEVEL STRUCTURE ---
        // Chapters:
        // 1: Yerle≈ütirme (1-3)
        // 2: Engellerden Ka√ßƒ±≈ü (4-6) - REPLACED "Eksik Tamamlama"
        // 3: Hata Ayƒ±klama (7-9)
        // 4: Karma≈üƒ±k Yollar (10-12)
        // 5: Hepsini Topla (13-15)
        // 6: D√∂ng√ºler / Tekrar (16-20) - NEW

        const levels = [
            // --- B√ñL√úM 1: YERLE≈ûTƒ∞RME ---
            { id: 1, chapter: "B√ñL√úM 1: Giri≈ü", subLevel: 1, gridSize: 5, start: { x: 0, y: 2 }, items: [{ x: 3, y: 2, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'reach_target', optimal: 3, dialogue: "Merhaba! Palamuda gitmeme yardƒ±m et." },
            { id: 2, chapter: "B√ñL√úM 1: Giri≈ü", subLevel: 2, gridSize: 5, start: { x: 2, y: 0 }, items: [{ x: 2, y: 3, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'reach_target', optimal: 3, dialogue: "A≈üaƒüƒ±ya doƒüru gitmeliyiz." },
            { id: 3, chapter: "B√ñL√úM 1: Giri≈ü", subLevel: 3, gridSize: 5, start: { x: 1, y: 1 }, items: [{ x: 3, y: 3, type: 'primary', collected: false }], obstacles: [{ x: 2, y: 1 }], prefilled: [], goal: 'reach_target', optimal: 4, dialogue: "√ñn√ºmde ta≈ü var, etrafƒ±ndan dola≈ü!" },

            // --- B√ñL√úM 2: ENGELLERDEN KA√áI≈û (NEW) ---
            { id: 4, chapter: "B√ñL√úM 2: Engeller", subLevel: 1, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 4, y: 0, type: 'primary', collected: false }], obstacles: [{x:2, y:0}, {x:2, y:1}], prefilled: [], goal: 'reach_target', optimal: 6, dialogue: "Duvar var! A≈üaƒüƒ±dan dola≈ü." },
            { id: 5, chapter: "B√ñL√úM 2: Engeller", subLevel: 2, gridSize: 5, start: { x: 0, y: 2 }, items: [{ x: 4, y: 2, type: 'primary', collected: false }], obstacles: [{x:2, y:2}, {x:2, y:1}, {x:2, y:3}], prefilled: [], goal: 'reach_target', optimal: 6, dialogue: "Bu duvar √ßok uzun, etrafƒ±ndan ge√ßmelisin." },
            { id: 6, chapter: "B√ñL√úM 2: Engeller", subLevel: 3, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 4, y: 4, type: 'primary', collected: false }], obstacles: [{x:1, y:1}, {x:2, y:2}, {x:3, y:3}], prefilled: [], goal: 'reach_target', optimal: 8, dialogue: "√áapraz gidemem, zikzak √ßizmeliyiz!" },

            // --- B√ñL√úM 3: HATA AYIKLAMA ---
            { id: 7, chapter: "B√ñL√úM 3: Hata D√ºzelt", subLevel: 1, gridSize: 5, start: { x: 1, y: 2 }, items: [{ x: 4, y: 2, type: 'primary', collected: false }], obstacles: [{x:2, y:1}], prefilled: [{cmd:'right'}, {cmd:'up'}, {cmd:'right'}], goal: 'reach_target', optimal: 3, dialogue: "Bir ≈üeyler yanlƒ±≈ü... Yukarƒ±da ta≈ü var!" },
            { id: 8, chapter: "B√ñL√úM 3: Hata D√ºzelt", subLevel: 2, gridSize: 5, start: { x: 2, y: 2 }, items: [{ x: 2, y: 4, type: 'primary', collected: false }], obstacles: [{x:3, y:3}], prefilled: [{cmd:'down'}, {cmd:'right'}, {cmd:'down'}], goal: 'reach_target', optimal: 2, dialogue: "Saƒüa gidersem kaybolurum!" }, 
            { id: 9, chapter: "B√ñL√úM 3: Hata D√ºzelt", subLevel: 3, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 4, y: 4, type: 'primary', collected: false }], obstacles: [{x:2, y:2}], prefilled: [{cmd:'right'}, {cmd:'right'}, {cmd:'down'}, {cmd:'down'}, {cmd:'left'}, {cmd:'right'}], goal: 'reach_target', optimal: 8, dialogue: "Gereksiz hareketleri siler misin?" },

            // --- B√ñL√úM 4: KARMA≈ûIK YOLLAR ---
            { id: 10, chapter: "B√ñL√úM 4: Labirent", subLevel: 1, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 3, y: 3, type: 'primary', collected: false }], obstacles: [{x:1, y:0}, {x:3, y:2}, {x:1, y:2}], prefilled: [], goal: 'reach_target', optimal: 6, dialogue: "Doƒüru yolu bulabilir misin?" },
            { id: 11, chapter: "B√ñL√úM 4: Labirent", subLevel: 2, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 4, y: 0, type: 'primary', collected: false }], obstacles: [{x:1, y:0}, {x:3, y:0}, {x:1, y:1}, {x:3, y:1}], prefilled: [], goal: 'reach_target', optimal: 8, dialogue: "Zikzak √ßizmemiz lazƒ±m!" }, 
            { id: 12, chapter: "B√ñL√úM 4: Labirent", subLevel: 3, gridSize: 5, start: { x: 2, y: 2 }, items: [{ x: 2, y: 2, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'reach_target', optimal: 0, dialogue: "Zaten hedeftesin! (≈ûaka ≈üaka, hedef ≈üurada ->)", start: {x:0, y:0}, items: [{x:4, y:4, type:'primary'}] }, // Fixed logic below

            // --- B√ñL√úM 5: HEPSƒ∞Nƒ∞ TOPLA ---
            { id: 13, chapter: "B√ñL√úM 5: Topla", subLevel: 1, gridSize: 5, start: { x: 2, y: 2 }, items: [{ x: 2, y: 0, type: 'primary', collected: false }, { x: 2, y: 4, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'collect_all', optimal: 4, dialogue: "ƒ∞ki tane var! ƒ∞kisini de al." },
            { id: 14, chapter: "B√ñL√úM 5: Topla", subLevel: 2, gridSize: 5, start: { x: 0, y: 2 }, items: [{ x: 2, y: 2, type: 'primary', collected: false }, { x: 4, y: 2, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'collect_all', optimal: 4, dialogue: "Sƒ±rayla hepsini topla!" },
            { id: 15, chapter: "B√ñL√úM 5: Topla", subLevel: 3, gridSize: 5, start: { x: 2, y: 2 }, items: [{ x: 2, y: 0, type: 'primary', collected: false }, { x: 2, y: 4, type: 'primary', collected: false }, { x: 0, y: 2, type: 'primary', collected: false }, { x: 4, y: 2, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'collect_all', optimal: 8, dialogue: "D√∂rt tarafƒ±m palamut dolu!" },

            // --- B√ñL√úM 6: D√ñNG√úLER (NEW LOOP LEVELS) ---
            { id: 16, chapter: "B√ñL√úM 6: D√∂ng√ºler", subLevel: 1, gridSize: 5, start: { x: 0, y: 2 }, items: [{ x: 4, y: 2, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'reach_target', optimal: 1, hasLoops: true, dialogue: "√áok uzak! '4x' butonuna basƒ±p Saƒüa tƒ±kla." },
            { id: 17, chapter: "B√ñL√úM 6: D√∂ng√ºler", subLevel: 2, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 4, y: 4, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'reach_target', optimal: 2, hasLoops: true, dialogue: "4 Saƒüa, sonra 4 A≈üaƒüƒ±. Kolayca yapabilirsin!" },
            { id: 18, chapter: "B√ñL√úM 6: D√∂ng√ºler", subLevel: 3, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 0, y: 4, type: 'primary', collected: false }], obstacles: [{x:1, y:1}, {x:2, y:2}, {x:3, y:3}], prefilled: [], goal: 'reach_target', optimal: 3, dialogue: "K√∂≈üeden dola≈ü: 4 Saƒüa, 4 A≈üaƒüƒ±, 4 Sola." },
            { id: 19, chapter: "B√ñL√úM 6: D√∂ng√ºler", subLevel: 4, gridSize: 5, start: { x: 2, y: 2 }, items: [{ x: 2, y: 0, type: 'primary', collected: false }, { x: 2, y: 4, type: 'primary', collected: false }, { x: 0, y: 2, type: 'primary', collected: false }, { x: 4, y: 2, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'collect_all', optimal: 4, hasLoops: true, dialogue: "Hepsini tek blokla toplayabilirsin!" },
            { id: 20, chapter: "B√ñL√úM 6: D√∂ng√ºler", subLevel: 5, gridSize: 5, start: { x: 0, y: 0 }, items: [{ x: 4, y: 0, type: 'primary', collected: false }, { x: 4, y: 4, type: 'primary', collected: false }, { x: 0, y: 4, type: 'primary', collected: false }], obstacles: [], prefilled: [], goal: 'collect_all', optimal: 3, hasLoops: true, dialogue: "B√ºy√ºk bir kare √ßizerek hepsini topla." }
        ];

        function initGame() {
            loadProgress();
            loadLevel(currentLevelIndex);
        }

        function saveProgress() {
            const data = {
                level: currentLevelIndex,
                maxUnlocked: maxUnlockedLevel,
                stars: levelStars
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        }

        function loadProgress() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    maxUnlockedLevel = data.maxUnlocked || 0;
                    levelStars = data.stars || {};
                    currentLevelIndex = data.level > maxUnlockedLevel ? maxUnlockedLevel : data.level;
                } catch (e) { console.error("Save corrupted"); }
            }
        }

        function resetProgress() {
            if(confirm("T√ºm ilerlemen silinecek. Emin misin?")) {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
            }
        }

        function toggleSpeed() {
            isFastMode = !isFastMode;
            gameSpeed = isFastMode ? 200 : 600;
            const btn = document.getElementById('speed-btn');
            btn.innerText = isFastMode ? 'üê∞' : 'üê¢';
            btn.classList.toggle('bg-indigo-100');
            btn.classList.toggle('bg-green-100');
        }

        function setTheme(themeKey) {
            currentTheme = themes[themeKey];
            document.getElementById('main-body').className = `h-screen flex flex-col overflow-hidden theme-transition ${currentTheme.bgClass} text-slate-800 select-none`;
            document.getElementById('header-icon').innerText = currentTheme.playerIcon;
            document.getElementById('brand-color').className = currentTheme.accentText;
            renderBoard();
        }

        function loadLevel(idx) {
            if (idx < 0) idx = 0;
            if (idx >= levels.length) idx = levels.length - 1;
            if (idx > maxUnlockedLevel) return;

            resetHintTimer();
            activeLoopCount = 1; // Reset loop multiplier
            updateLoopUI();

            currentLevelIndex = idx;
            const level = levels[currentLevelIndex];
            
            document.getElementById('chapter-title').innerText = level.chapter;
            document.getElementById('level-indicator').innerText = `Seviye ${level.subLevel}`;
            
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('fail-modal').classList.add('hidden');
            document.getElementById('level-menu').classList.add('hidden');
            
            const instructionEl = document.getElementById('instruction-text');
            if (level.goal === 'collect_all') instructionEl.innerText = "Hepsini Topla!";
            else if (level.chapter.includes("HATA")) instructionEl.innerText = "Hatayƒ± D√ºzelt";
            else if (level.chapter.includes("TAMAMLA")) instructionEl.innerText = "Kodu Tamamla";
            else instructionEl.innerText = "Hedefe Ula≈ü";

            // Loop Controls Visibility
            const loopControls = document.getElementById('loop-controls');
            const loopIndicator = document.getElementById('loop-indicator');
            if (level.hasLoops) {
                loopControls.classList.remove('hidden');
                loopIndicator.classList.remove('hidden');
            } else {
                loopControls.classList.add('hidden');
                loopIndicator.classList.add('hidden');
            }

            // Handle prefilled data which might be simple strings or objects
            // Convert simple strings to command objects {cmd, count}
            workspace = level.prefilled.map(item => {
                if (typeof item === 'string') return { cmd: item, count: 1 };
                return { cmd: item.cmd, count: item.count || 1 };
            });

            playerPos = { ...level.start };
            collectedItems = 0;
            isRunning = false;
            level.items.forEach(i => i.collected = false);
            playerFacing = 'right';

            renderWorkspace();
            renderBoard();
            
            if (level.dialogue) showDialogue(level.dialogue, level.start.x, level.start.y);

            saveProgress();
            startHintTimer();
        }

        function setLoop(count) {
            // Toggle logic: if clicking same, reset to 1
            if (activeLoopCount === count) {
                activeLoopCount = 1;
            } else {
                activeLoopCount = count;
            }
            updateLoopUI();
        }

        function updateLoopUI() {
            const btns = document.querySelectorAll('.loop-btn');
            btns.forEach(btn => {
                const count = parseInt(btn.innerText);
                if (count === activeLoopCount) {
                    btn.classList.add('bg-purple-600', 'text-white', 'border-purple-700', 'ring-2', 'ring-purple-300');
                    btn.classList.remove('bg-purple-100', 'text-purple-700', 'border-purple-300');
                } else {
                    btn.classList.remove('bg-purple-600', 'text-white', 'border-purple-700', 'ring-2', 'ring-purple-300');
                    btn.classList.add('bg-purple-100', 'text-purple-700', 'border-purple-300');
                }
            });
        }

        function prevLevel() {
            if (currentLevelIndex > 0) loadLevel(currentLevelIndex - 1);
        }

        function nextLevel() {
            if (currentLevelIndex < levels.length - 1 && currentLevelIndex < maxUnlockedLevel) {
                loadLevel(currentLevelIndex + 1);
            } else if (currentLevelIndex === maxUnlockedLevel && currentLevelIndex < levels.length - 1) {
                // ...
            }
        }

        function showDialogue(text, x, y) {
            const old = document.querySelectorAll('.speech-bubble');
            old.forEach(el => el.remove());
            const cell = document.getElementById(`cell-${x}-${y}`);
            if (cell) {
                const bubble = document.createElement('div');
                bubble.className = 'speech-bubble';
                bubble.innerText = text;
                bubble.style.bottom = '100%';
                bubble.style.marginBottom = '15px';
                cell.appendChild(bubble);
                setTimeout(() => { if(bubble) bubble.remove(); }, 4000);
            }
        }

        function startHintTimer() {
            clearTimeout(hintTimer);
            document.getElementById('hint-container').innerHTML = '';
            hintTimer = setTimeout(showHint, hintDelay);
        }

        function resetHintTimer() {
            clearTimeout(hintTimer);
            document.getElementById('hint-container').innerHTML = '';
            if (!isRunning) hintTimer = setTimeout(showHint, hintDelay);
        }

        function showHint() {
            if (isRunning) return;
            const level = levels[currentLevelIndex];
            const target = level.items.find(i => !i.collected);
            if (!target) return;

            let simX = level.start.x;
            let simY = level.start.y;
            workspace.forEach(block => {
                for(let k=0; k<block.count; k++) {
                   if(block.cmd === 'up') simY--;
                   if(block.cmd === 'down') simY++;
                   if(block.cmd === 'left') simX--;
                   if(block.cmd === 'right') simX++;
                }
            });

            let suggestedBtnId = '';
            // Basic hint logic - doesn't account for walls or loops perfectly
            if (target.x > simX) suggestedBtnId = 'btn-right';
            else if (target.x < simX) suggestedBtnId = 'btn-left';
            else if (target.y > simY) suggestedBtnId = 'btn-down';
            else if (target.y < simY) suggestedBtnId = 'btn-up';

            if (suggestedBtnId) {
                const btn = document.getElementById(suggestedBtnId);
                const container = document.getElementById('hint-container');
                const hand = document.createElement('div');
                hand.className = 'hint-hand';
                hand.innerText = 'üëÜ';
                const btnRect = btn.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                hand.style.left = (btnRect.left - containerRect.left + btnRect.width/2 - 20) + 'px';
                hand.style.top = (btnRect.top - containerRect.top + btnRect.height) + 'px';
                container.appendChild(hand);
            }
        }

        let dragSrcEl = null;
        let dragSrcIndex = -1;

        function handleDragStart(e) {
            dragSrcEl = this;
            dragSrcIndex = parseInt(this.getAttribute('data-index'));
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragLeave(e) { this.classList.remove('drag-over'); }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            this.classList.remove('drag-over');
            const dragDestIndex = parseInt(this.getAttribute('data-index'));
            if (dragSrcIndex !== dragDestIndex) {
                const item = workspace[dragSrcIndex];
                workspace.splice(dragSrcIndex, 1);
                workspace.splice(dragDestIndex, 0, item);
                renderWorkspace();
                renderBoard();
                resetHintTimer();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('#code-grid .group').forEach(item => item.classList.remove('drag-over'));
        }

        function calculatePath() {
            if (isRunning) return [];
            const level = levels[currentLevelIndex];
            let simX = level.start.x;
            let simY = level.start.y;
            let path = [];
            workspace.forEach(block => {
                for(let k=0; k<block.count; k++) {
                    let nextX = simX, nextY = simY;
                    if (block.cmd === 'up') nextY--;
                    if (block.cmd === 'down') nextY++;
                    if (block.cmd === 'left') nextX--;
                    if (block.cmd === 'right') nextX++;
                    
                    if (nextX >= 0 && nextX < level.gridSize && nextY >= 0 && nextY < level.gridSize) {
                        path.push({x: nextX, y: nextY});
                        simX = nextX;
                        simY = nextY;
                    }
                }
            });
            return path;
        }

        function renderBoard() {
            const level = levels[currentLevelIndex];
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            
            const previewPath = calculatePath();
            const lastStep = previewPath.length > 0 ? previewPath[previewPath.length - 1] : null;

            for (let y = 0; y < level.gridSize; y++) {
                for (let x = 0; x < level.gridSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = `relative rounded-2xl flex items-center justify-center text-4xl shadow-sm border-2 transition-all duration-300 ${currentTheme.cellClass}`;
                    cell.id = `cell-${x}-${y}`;

                    const obs = level.obstacles.find(o => o.x === x && o.y === y);
                    if (obs) cell.innerText = currentTheme.obstacleIcon;

                    const item = level.items.find(i => i.x === x && i.y === y && !i.collected);
                    if (item) cell.innerText = item.type === 'primary' ? currentTheme.targetPrimary : currentTheme.targetSecondary;

                    const inPath = previewPath.some(p => p.x === x && p.y === y);
                    if (inPath && !obs && !isRunning) {
                         const isLastStep = lastStep && lastStep.x === x && lastStep.y === y;
                         const dot = document.createElement('div');
                         dot.className = isLastStep ? 'preview-target' : 'preview-dot';
                         if(!isLastStep) dot.style.backgroundColor = currentTheme.dotColor;
                         cell.appendChild(dot);
                    }

                    if (playerPos.x === x && playerPos.y === y) {
                        const player = document.createElement('div');
                        player.innerText = currentTheme.playerIcon;
                        player.className = 'robot-move absolute text-5xl filter drop-shadow-xl z-10 transition-transform duration-300';
                        let scale = 1;
                        if (currentTheme.defaultFacing === 'left') {
                            if (playerFacing === 'right') scale = -1;
                        } else {
                            if (playerFacing === 'left') scale = -1;
                        }
                        player.style.transform = `scaleX(${scale})`;
                        cell.appendChild(player);
                    }
                    board.appendChild(cell);
                }
            }
        }

        function renderWorkspace() {
            const grid = document.getElementById('code-grid');
            grid.innerHTML = '';
            
            if (workspace.length === 0) {
                 grid.innerHTML = `
                    <div class="col-span-full text-center mt-10 opacity-30 select-none">
                        <div class="text-5xl md:text-6xl mb-2">üß©</div>
                        <div class="font-bold text-slate-800 text-sm md:text-base">Bloklarƒ± buraya diz</div>
                    </div>`;
                 return;
            }

            workspace.forEach((block, index) => {
                let color = '', icon = '';
                switch(block.cmd) {
                    case 'up': color = 'bg-blue-500 border-blue-600'; icon = '‚¨ÜÔ∏è'; break;
                    case 'down': color = 'bg-violet-500 border-violet-600'; icon = '‚¨áÔ∏è'; break;
                    case 'left': color = 'bg-amber-500 border-amber-600'; icon = '‚¨ÖÔ∏è'; break;
                    case 'right': color = 'bg-rose-500 border-rose-600'; icon = '‚û°Ô∏è'; break;
                }

                const el = document.createElement('div');
                el.className = `pop-in flex items-center justify-center p-2 rounded-xl text-white font-bold text-xl shadow-sm border-b-4 ${color} relative group h-14 w-full select-none cursor-grab active:cursor-grabbing`;
                el.setAttribute('draggable', 'true');
                el.setAttribute('data-index', index);
                
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('dragend', handleDragEnd);

                // Add count badge if > 1
                const countBadge = block.count > 1 ? 
                    `<span class="absolute -top-3 -left-2 bg-yellow-400 text-slate-900 border-2 border-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-black shadow-lg z-10">${block.count}x</span>` 
                    : '';

                el.innerHTML = `
                    ${countBadge}
                    <span class="absolute top-1 left-1.5 text-[10px] opacity-70 leading-none">${index + 1}</span>
                    <span class="text-2xl">${icon}</span>
                    <button onclick="removeBlock(${index})" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-md scale-0 group-hover:scale-100 transition-transform z-20">‚úï</button>
                `;
                grid.appendChild(el);
            });
            const area = document.getElementById('code-area');
            area.scrollTop = area.scrollHeight;
        }

        function addCommand(cmd) {
            if (isRunning) return;
            // Add object { cmd: 'up', count: 1 } instead of string
            workspace.push({ cmd: cmd, count: activeLoopCount });
            
            // Reset loop count after adding unless user wants sticky? 
            // Better UX for kids: Reset to 1 to prevent accidental loops
            activeLoopCount = 1;
            updateLoopUI();
            
            renderWorkspace();
            renderBoard();
            resetHintTimer();
        }

        function removeBlock(idx) {
            if (isRunning) return;
            workspace.splice(idx, 1);
            renderWorkspace();
            renderBoard();
            resetHintTimer();
        }

        function clearWorkspace() {
            if (isRunning) return;
            workspace = [];
            renderWorkspace();
            renderBoard();
            resetHintTimer();
        }

        async function runCode() {
            if (isRunning || workspace.length === 0) return;
            isRunning = true;
            document.getElementById('run-btn').classList.add('opacity-50', 'cursor-not-allowed');

            const level = levels[currentLevelIndex];
            playerPos = { ...level.start };
            level.items.forEach(i => i.collected = false);
            collectedItems = 0;
            playerFacing = 'right';

            renderBoard();

            for (let i = 0; i < workspace.length; i++) {
                const block = workspace[i];
                // Execute block.count times
                for(let k=0; k < block.count; k++) {
                    await executeCommand(block.cmd);
                    await new Promise(r => setTimeout(r, gameSpeed));
                }
            }

            checkWin();
            isRunning = false;
            document.getElementById('run-btn').classList.remove('opacity-50', 'cursor-not-allowed');
            resetHintTimer();
        }

        async function executeCommand(cmd) {
            const level = levels[currentLevelIndex];
            let newX = playerPos.x;
            let newY = playerPos.y;

            if (cmd === 'left') playerFacing = 'left';
            if (cmd === 'right') playerFacing = 'right';

            if (cmd === 'up') newY--;
            if (cmd === 'down') newY++;
            if (cmd === 'left') newX--;
            if (cmd === 'right') newX++;

            // Bounds
            if (newX < 0 || newX >= level.gridSize || newY < 0 || newY >= level.gridSize) {
                shakeBoard(); return;
            }
            const obs = level.obstacles.find(o => o.x === newX && o.y === newY);
            if (obs) {
                shakeBoard(); return;
            }

            // Move
            playerPos.x = newX;
            playerPos.y = newY;
            
            // Check Auto Collect
            const item = level.items.find(i => i.x === playerPos.x && i.y === playerPos.y && !i.collected);
            if (item) {
                item.collected = true;
                createConfetti(playerPos.x, playerPos.y);
                collectedItems++;
            }

            renderBoard();
        }

        function createConfetti(x, y) {
            const cell = document.getElementById(`cell-${x}-${y}`);
            if(!cell) return;
            for(let i=0; i<12; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = ['#f43f5e', '#3b82f6', '#fbbf24', '#10b981'][Math.floor(Math.random()*4)];
                p.style.left = '50%';
                p.style.top = '50%';
                const angle = Math.random() * Math.PI * 2;
                const dist = 30 + Math.random() * 30;
                const tx = Math.cos(angle) * dist + 'px';
                const ty = Math.sin(angle) * dist + 'px';
                p.style.setProperty('--tx', tx);
                p.style.setProperty('--ty', ty);
                cell.appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
        }

        function shakeBoard() {
            const b = document.getElementById('game-board').parentElement;
            b.animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(-10px)' },
                { transform: 'translateX(10px)' },
                { transform: 'translateX(0)' }
            ], { duration: 300 });
        }

        function checkWin() {
            const level = levels[currentLevelIndex];
            let won = false;
            
            // Logic: if goal is reach_target, check robot pos. If collect_all, check all collected.
            if (level.goal === 'reach_target') {
                const targets = level.items;
                const onTarget = targets.find(t => t.x === playerPos.x && t.y === playerPos.y);
                if (onTarget) won = true;
            } else {
                won = level.items.every(i => i.collected);
            }

            if (won) {
                if (currentLevelIndex === maxUnlockedLevel && currentLevelIndex < levels.length - 1) {
                    maxUnlockedLevel++;
                }
                const blocksUsed = workspace.length;
                const optimal = level.optimal || blocksUsed;
                let stars = 1;
                if (blocksUsed <= optimal) stars = 3;
                else if (blocksUsed <= optimal + 2) stars = 2;
                
                if (!levelStars[currentLevelIndex] || stars > levelStars[currentLevelIndex]) {
                    levelStars[currentLevelIndex] = stars;
                }
                saveProgress();
                showWinModal(stars);
            } else {
                document.getElementById('fail-modal').classList.remove('hidden');
            }
        }

        function showWinModal(stars) {
            const container = document.getElementById('star-container');
            container.innerHTML = '';
            for(let i=1; i<=3; i++) {
                const s = document.createElement('div');
                s.className = `text-5xl transition-all duration-500 ${i <= stars ? 'text-yellow-400 star-pop delay-'+i : 'text-gray-200'}`;
                s.innerText = '‚≠ê';
                container.appendChild(s);
            }
            document.getElementById('result-modal').classList.remove('hidden');
        }

        function nextLevel() {
            if (currentLevelIndex < levels.length - 1 && currentLevelIndex < maxUnlockedLevel) {
                 loadLevel(currentLevelIndex + 1);
            } else if (currentLevelIndex === levels.length - 1) {
                alert("Tebrikler! T√ºm seviyeleri bitirdin.");
                toggleLevelMenu();
            } else {
                // Try to load next even if logic says wait, checkWin unlocks it first usually
                if(currentLevelIndex < levels.length - 1) loadLevel(currentLevelIndex + 1);
            }
        }

        function retryLevel() { loadLevel(currentLevelIndex); }

        function toggleLevelMenu() {
            const menu = document.getElementById('level-menu');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) renderLevelGrid();
        }

        function renderLevelGrid() {
            const grid = document.getElementById('level-grid');
            grid.innerHTML = '';
            levels.forEach((lvl, idx) => {
                const isLocked = idx > maxUnlockedLevel;
                const stars = levelStars[idx] || 0;
                const btn = document.createElement('button');
                btn.className = `p-4 rounded-xl flex flex-col items-center justify-center relative border-4 transition-all ${isLocked ? 'bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed' : 'bg-white border-blue-200 hover:border-blue-400 hover:scale-105 text-slate-700 shadow-md'}`;
                if (isLocked) {
                    btn.innerHTML = `<span class="text-3xl mb-1 grayscale opacity-50">üîí</span><span class="text-xs font-bold">Seviye ${idx+1}</span>`;
                } else {
                    let starStr = '';
                    for(let i=0; i<3; i++) starStr += i < stars ? '‚≠ê' : '‚òÜ';
                    btn.innerHTML = `
                        <span class="text-2xl font-black mb-1">${idx+1}</span>
                        <span class="text-[10px] text-yellow-500 tracking-tighter">${starStr}</span>
                    `;
                    btn.onclick = () => { loadLevel(idx); toggleLevelMenu(); };
                }
                if(idx === currentLevelIndex) btn.classList.add('ring-4', 'ring-blue-500', 'ring-offset-2');
                grid.appendChild(btn);
            });
        }

        initGame();
    </script>
</body>
</html>
